<?php

/**
 * News.
 *
 * @copyright Michael Ueberschaer (MU)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Michael Ueberschaer <info@homepages-mit-zikula.de>.
 *
 * @see https://homepages-mit-zikula.de
 * @see https://ziku.la
 *
 * @version Generated by ModuleStudio (https://modulestudio.de).
 */

declare(strict_types=1);

namespace MU\NewsModule\ContentType\Base;

use Symfony\Component\HttpKernel\Controller\ControllerReference;
use Symfony\Component\HttpKernel\Fragment\FragmentHandler;
use Zikula\ExtensionsModule\ModuleInterface\Content\AbstractContentType;
use MU\NewsModule\ContentType\Form\Type\ItemType as FormType;
use MU\NewsModule\Helper\ControllerHelper;

/**
 * Generic single item display content type base class.
 */
abstract class AbstractItemType extends AbstractContentType
{
    /**
     * @var ControllerHelper
     */
    protected $controllerHelper;
    
    /**
     * @var FragmentHandler
     */
    protected $fragmentHandler;
    
    public function getIcon(): string
    {
        return 'circle-o';
    }
    
    public function getTitle(): string
    {
        return $this->translator->trans('News detail');
    }
    
    public function getDescription(): string
    {
        return $this->translator->trans('Display or link a single news object.');
    }
    
    public function getDefaultData(): array
    {
        return [
            'objectType' => 'message',
            'id' => null,
            'displayMode' => 'embed',
            'customTemplate' => null,
        ];
    }
    
    public function getData(): array
    {
        $data = parent::getData();
    
        $contextArgs = ['name' => 'detail'];
        $allowedObjectTypes = $this->controllerHelper->getObjectTypes('contentType', $contextArgs);
        if (
            !isset($data['objectType'])
            || !in_array($data['objectType'], $allowedObjectTypes, true)
        ) {
            $data['objectType'] = $this->controllerHelper->getDefaultObjectType('contentType', $contextArgs);
            $this->data = $data;
        }
    
        return $data;
    }
    
    public function displayView(): string
    {
        if (null === $this->data['id'] || empty($this->data['id']) || empty($this->data['displayMode'])) {
            return '';
        }
    
        $controllerReference = new ControllerReference(
            'MU\NewsModule\Controller\ExternalController::displayAction',
            $this->getDisplayArguments(),
            [
                'template' => $this->data['customTemplate']
            ]
        );
    
        return $this->fragmentHandler->render($controllerReference, 'inline', []);
    }
    
    public function displayEditing(): string
    {
        if (null === $this->data['id'] || empty($this->data['id']) || empty($this->data['displayMode'])) {
            return $this->translator->trans('No item selected.');
        }
    
        return parent::displayEditing();
    }
    
    /**
     * Returns common arguments for displaying the selected object using the external controller.
     */
    protected function getDisplayArguments(): array
    {
        return [
            'objectType' => $this->data['objectType'],
            'id' => $this->data['id'],
            'source' => 'contentType',
            'displayMode' => $this->data['displayMode'],
        ];
    }
    
    public function getEditFormClass(): string
    {
        return FormType::class;
    }
    
    public function getEditFormOptions($context): array
    {
        $options = parent::getEditFormOptions($context);
        $data = $this->getData();
        $options['object_type'] = $data['objectType'];
    
        return $options;
    }
    
    /**
     * @required
     */
    public function setControllerHelper(ControllerHelper $controllerHelper): void
    {
        $this->controllerHelper = $controllerHelper;
    }
    
    /**
     * @required
     */
    public function setFragmentHandler(FragmentHandler $fragmentHandler): void
    {
        $this->fragmentHandler = $fragmentHandler;
    }
}
